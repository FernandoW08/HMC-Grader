{% extends "base-layout.html" %}

{% block title %}
Assignments for {{course.name}}
{% endblock %}

{% block rows %}
<div class="row">
  <div class="col-sm-2">
  </div>
  <div class="col-sm-8">
    <h3>Submssion for: {{course.name}}/{{assignment.name}}/{{problem.name}}</h3>
    <h3>User: {% if not course.anonymousGrading %}{{user.username}}{% else %}{{course.getIdentifier(user.username)}}{% endif %}</h3>
  </div>
  <div class="col-sm-2">
  </div>
</div>
<div class="row">
  <div class="col-sm-2">
  </div>
  <div class="col-sm-4">
    <h3>Submission Properties</h3>
    <table class="table table-bordered">
      <tr>
        <th>Submission Number</th>
        <td>
          <div class="btn-group">
            <button type="button" class="btn btn-default">{{subnum}}</button>
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
              {% for i in range(1,problem.getSubmissionNumber(user)+1) %}
              <li><a href="{{url_for('grutorGradeSubmission', pid=problem.id, uid=user.id, subnum=i)}}">{{i}}</a></li>
              {% endfor %}
            </ul>
          </div>
        </td>
      </tr>
      <tr>
        <th>Submission Time</th>
        <td class="time">{{submission.submissionTime.isoformat()}}</td>
      </tr>
      <tr>
        <th>Partner</th>
        {% if submission.partnerInfo != None %}
        <td>{% if not course.anonymousGrading %}{{submission.partnerInfo.user.username}}{% else %}{{course.getIdentifier(submission.partnerInfo.user.username)}}{% endif %}</td>
        {% else %}
        <td>None</td>
        {% endif %}
      </tr>
      <tr>
        <th>Submission Status</th>
        {% with c,text = submission.getStatus() %}
        <td class="{{c}}">{% if submission.isLate %}<span style="color:red">[Late] </span>{% endif %}{{text}}</td>
        {% endwith %}
      </tr>
      <tr>
        <th>Toggle Late</th>
        <td>
          <button class="btn btn-xs btn-warning" id="toggleLate">Toggle</button>
        </td>
      </tr>
      <tr>
        <th>Grade Nodes</th>
        {% if problem.gradeNotes != None %}
        <td><a href="{{problem.gradeNotes}}" target="_blank" class="btn btn-primary btn-xs">Grading Notes</a></td>
        {% else %}
        <td>None</td>
        {% endif %}
      </tr>
      <tr>
        <td colspan="2" style="text-align:right">
          <a href="{{url_for('grutorReleaseSubmission', pid=problem.id, uid=user.id, subnum=subnum)}}" class="btn btn-danger btn-xs">Cancel Grade</a>
          <a href="{{url_for('grutorFinishSubmission', pid=problem.id, uid=user.id, subnum=subnum)}}" id="finishGrading" class="btn btn-success btn-xs">Finish Grading (save all)</a>
        </td>
      </tr>
    </table>
  </div>
  <div class="col-sm-4">
    <h3>Rubric</h3>
    <form role="form" onSubmit="return saveGrades()" id="scores">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Section</th>
            <th>Score</th>
            <th>Max Points</th>
          </tr>
        </thead>
        <tbody>
          {% for p in problem.rubric|dictsort %}
            <tr>
              <td>{{p[0]}}</td>
              <td><input class="form-control" name="{{p[0]}}" type="number" value="{{submission.grade.scores.setdefault(p[0], '0.0')}}"></td>
              <td>{{p[1]}}</td>
            </tr>
          {% endfor %}
            <tr>
              <td colspan="3" style="text-align:right"><button type="submit" class="btn btn-primary btn-xs"><span class="glyphicon glyphicon-floppy-disk"></span> Save Grades</button></td>
            </tr>
        </tbody>
      </table>
    </form>
  </div>
  <div class="col-sm-2">
  </div>
</div>


<div class="row">
  <div class="col-sm-2">
  </div>
  <div class="col-sm-8">
    <div class="panel panel-default" id="panelcomments">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-target="#collapseComments" href="#collapseComments" class="collapsed">
          Grader Comments
        </a>
      </h4>
    </div>
    <div id="collapseComments" class="panel-collapse collapse in">
      <div class="panel-body">
        <textarea id="commentarea" class="form-control" rows="6" {% if submission.comments|length == 0%}placeholder="No Comments"{% endif %}>{{ submission.comments }}</textarea>
        <br>
        <button type="button" class="btn btn-default" id="previewBtn">Preview</button>
        <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveComments()"><span class="glyphicon glyphicon-floppy-disk"></span> Save Comments</button>
      </div>
    </div>
  </div>
  </div>
  <div class="col-sm-2">
  </div>
</div>

<div class="row">
  <div class="col-sm-2">
  </div>
  <div class="col-sm-8">
    <div class="panel panel-default" id="panelcomments">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-target="#collapsePreview" href="#collapsePreview" class="collapsed">
          Grader Comments (Preview)
        </a>
      </h4>
    </div>
    <div id="collapsePreview" class="panel-collapse collapse in">
      <div class="panel-body" id="preview">
        {{ submission.comments|markdown}}
      </div>
    </div>
  </div>
  </div>
  <div class="col-sm-2">
  </div>
</div>

{% include 'widgets/filebrowser.html' %}
{% endblock %}

{% block scripts %}
{{super()}}
<script>
function saveGrades(){
  var values = {};
  console.log("called")
  $("form#scores :input").not(":input[type=submit]").each(function(){
    console.log($(this).val() + " " + $(this).attr("name"));
    values[$(this).attr("name")] = $(this).val();
  });
  //Send the data to the server
  $.ajax({
    url:"{{url_for('grutorSaveGrades', pid=problem.id, uid=user.id, subnum=subnum)}}",
    type:'POST',
    contentType:'application/json',
    data: JSON.stringify(values),
    dataType: 'json',
    success: function(data) {
      //Do nothing with returned data
    }
  });
  return false;
};

function saveComments(){
  values = {}
  values["text"] = $("#commentarea").val()
  $.ajax({
    url:"{{url_for('grutorSaveComment', pid=problem.id, uid=user.id, subnum=subnum)}}",
    type:'POST',
    contentType:'application/json',
    data: JSON.stringify(values),
    dataType: 'json',
    success: function(data) {
      //Nothing to do
    }
  });
}

$("#previewBtn").click(function(){
  values = {}
  values["text"] = $("#commentarea").val()
  $.ajax({
    url:"{{url_for('grutorPreview')}}",
    type:'POST',
    contentType:'application/json',
    data: JSON.stringify(values),
    dataType: 'json',
    success: function(data) {
      $("#preview").html(data["res"]);
    }
  });
})

//$("#saveBtn").click(saveComments());
$("#finishGrading").click(function(){
  saveGrades();
  saveComments();
})

$("#toggleLate").click(function(){
  $.ajax({
    url:"{{url_for('grutorToggleLate', pid=problem.id, uid=user.id, subnum=subnum)}}",
    success: function(data) {
      location.reload()
    }
  })
})
</script>

<script src="{{url_for('static', filename='moment.js')}}"></script>
<script>
$(".time").each(function(){
  var t = $(this).text();
  var d = new moment(t+"Z");
  $(this).text(d.format("lll"))
})
</script>
{% endblock %}
